<html>
<head>
<title>Storyteller</title>
<style>
body {
  background-color: #239cd9;
}

div#main {
  width: min(80em, 90%);
  margin: auto;
  position: absolute;
  bottom: 10px;
  left: 50%;
  transform: translate(-50%, -50%);
}

textarea#prompt {
  display: block;
  width: 100%;
  height: 3em;
  font-size: xxx-large;
  color: #444444;
}

button#start {
  display: block;
  width: 30%;
  margin: auto;
  font-size: xxx-large;
  color: #444444;
}

div#text {
  display: block;
  font-size: xx-large;
  color: #ffffff;
  background-color: rgba(0, 0, 0, 0.2);
  padding: 10px;
  visibility: hidden;
}

.shake {
  animation: shake 2.0s;
  animation-iteration-count: infinite;
}

@keyframes shake {
  0% { transform: translate(1px, 1px) rotate(0deg); }
  10% { transform: translate(-1px, -2px) rotate(-1deg); }
  20% { transform: translate(-3px, 0px) rotate(1deg); }
  30% { transform: translate(3px, 2px) rotate(0deg); }
  40% { transform: translate(1px, -1px) rotate(1deg); }
  50% { transform: translate(-1px, 2px) rotate(-1deg); }
  60% { transform: translate(-3px, 1px) rotate(0deg); }
  70% { transform: translate(3px, 1px) rotate(-1deg); }
  80% { transform: translate(-1px, -1px) rotate(1deg); }
  90% { transform: translate(1px, 2px) rotate(0deg); }
  100% { transform: translate(1px, -2px) rotate(-1deg); }
}
</style>
</head>
<body>

<div id="main">

<form id="form">
<textarea id="prompt">Tell me a story</textarea>
<br />
<button type="submit" id="start">Go</button>
</form>
<br />

</div>

<div id="text"></div>

<script>
var start_time = null;

async function start(event) {
  event.preventDefault();
  var prompt = document.getElementById("prompt").value;
  var button = document.getElementById("start");
  var text_div = document.getElementById("text");

  document.getElementById("form").classList.add("shake");
  start_time = new Date();
  button.disabled = true;

  var url = new URL(location.href);
  if (url.protocol == 'http:') {
    url.protocol = 'ws';
  } else if (url.protocol == 'https:') {
    url.protocol = 'wss';
  }
  url.pathname = '/websocket';

  var context = new AudioContext();
  var last_source = null;

  const ws = new WebSocket(url);
  ws.onopen = (event) => {
    ws.send(JSON.stringify({ "prompt": prompt }));
  };
  ws.onmessage = (event) => {
    if (button.disabled) {
      button.disabled = false;
      document.getElementById("form").classList.remove("shake");
      console.log("First data received in " + (new Date() - start_time) + "ms");
    }
    let data = JSON.parse(event.data);
    console.log("Text: " + data.text);

    let audio_buffer = Uint8Array.from(atob(data.audio), c => c.charCodeAt(0)).buffer;

    context.decodeAudioData(audio_buffer, (buffer) => {
      console.log("Audio duration: " + buffer.duration);
      let source = context.createBufferSource();
      source.buffer = buffer;
      source.connect(context.destination);
      source.onended = () => {
        if (last_source == source) {
          last_source = null;
          console.log("Audio ended");
        }
      };
      if (last_source == null) {
        source.start(0);
        console.log("Audio started");
        text_div.innerText = data.text;
        text_div.style.visibility = "visible";
      } else {
        last_source.onended = () => {
          source.start(0.3);
          console.log("Audio continued");
          window.setTimeout(() => {
            text_div.innerText = data.text;
          }, 150);
        };
      }
      last_source = source;
    });
  };
}

const form = document.getElementById("form");
form.addEventListener("submit", start);
</script>

</body>
</html>
